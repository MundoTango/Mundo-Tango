â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                   â•‘
â•‘        TIER 1.1: DEPLOYMENT AUTOMATION - Complete Documentation  â•‘
â•‘     One-Click Deploy to Vercel (Frontend) + Railway (Backend)    â•‘
â•‘                                                                   â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

FEATURE: Deployment Automation
TIER: 1 (Critical - Required for platform independence)
STATUS: IN PROGRESS (Database + Backend + Frontend layers built simultaneously)
CREATED: October 31, 2025
METHOD: MB.MD (Simultaneously, Recursively, Critically)

=======================================================================
ğŸ“‹ OVERVIEW
=======================================================================

GOAL: Enable one-click deployment from Mundo Tango to Vercel + Railway

USER EXPERIENCE:
1. User clicks "Deploy to Production" button
2. Real-time progress modal shows build status
3. Deployment completes in 2-3 minutes
4. User gets production URLs for frontend + backend

RESULT: Complete platform independence - no need for Replit deployment UI

=======================================================================
ğŸ—ï¸ ARCHITECTURE (3 LAYERS - BUILT SIMULTANEOUSLY)
=======================================================================

LAYER 1: DATABASE (shared/platform-schema.ts)
  â”œâ”€ deployments table
  â”‚  â€¢ Tracks all deployments (production/preview/rollback)
  â”‚  â€¢ Stores status, URLs, build logs, timing
  â”‚  â€¢ References users.id (serial primary key)
  â”‚
  â”œâ”€ platform_integrations table
  â”‚  â€¢ Stores API keys for Vercel, Railway, GitHub
  â”‚  â€¢ JSONB settings field (encrypted)
  â”‚  â€¢ Unique constraint: (user_id, platform)
  â”‚
  â””â”€ environment_variables table (for Tier 1.2)
     â€¢ Stores encrypted env vars
     â€¢ Tracks sync status to Vercel/Railway
     â€¢ Supports dev/preview/production environments

LAYER 2: BACKEND (server/routes/deployments.ts)
  â”œâ”€ POST /api/deployments
  â”‚  â€¢ Creates new deployment
  â”‚  â€¢ Gets latest commit from GitHub
  â”‚  â€¢ Triggers Vercel + Railway deploy
  â”‚  â€¢ Returns deployment object
  â”‚
  â”œâ”€ GET /api/deployments
  â”‚  â€¢ Lists all deployments for user
  â”‚  â€¢ Supports filtering (type, status)
  â”‚  â€¢ Pagination (limit, offset)
  â”‚
  â”œâ”€ GET /api/deployments/:id
  â”‚  â€¢ Gets specific deployment details
  â”‚  â€¢ Includes build logs
  â”‚
  â”œâ”€ PATCH /api/deployments/:id
  â”‚  â€¢ Updates deployment status
  â”‚  â€¢ Used by webhook handlers
  â”‚
  â””â”€ POST /api/deployments/:id/cancel
     â€¢ Cancels in-progress deployment

LAYER 3: FRONTEND (client/src/components/platform/DeployButton.tsx)
  â”œâ”€ DeployButton component
  â”‚  â€¢ Single button: "Deploy to Production"
  â”‚  â€¢ Shows loading state during deployment
  â”‚  â€¢ Opens progress dialog
  â”‚
  â””â”€ Progress Dialog
     â€¢ Real-time status updates
     â€¢ Progress bar (0-100%)
     â€¢ Git commit info
     â€¢ Deployment URLs (when complete)
     â€¢ Error messages (if failed)
     â€¢ Action buttons (Cancel/Retry/Close)

=======================================================================
ğŸ”„ DEPLOYMENT FLOW
=======================================================================

STEP 1: USER CLICKS DEPLOY
  User: Clicks "Deploy to Production" button
  Frontend: Sends POST /api/deployments { type: "production", gitBranch: "main" }

STEP 2: BACKEND CREATES DEPLOYMENT
  Backend: Creates deployment record (status: "pending")
  Backend: Gets latest commit from GitHub API
  Backend: Returns deployment object to frontend

STEP 3: FRONTEND SHOWS PROGRESS
  Frontend: Opens dialog with deployment status
  Frontend: Shows "Pending" â†’ "Building" â†’ "Deploying" â†’ "Success"
  Frontend: Updates progress bar (10% â†’ 40% â†’ 70% â†’ 100%)

STEP 4: BACKEND TRIGGERS VERCEL
  Backend: Calls Vercel API to deploy frontend
  Backend: Monitors build status
  Backend: Updates deployment.status = "building"
  Backend: Stores vercel_deployment_id

STEP 5: BACKEND TRIGGERS RAILWAY
  Backend: Calls Railway API to deploy backend
  Backend: Monitors build status
  Backend: Updates deployment.status = "deploying"
  Backend: Stores railway_deployment_id

STEP 6: DEPLOYMENT COMPLETES
  Backend: Both deployments succeed
  Backend: Updates deployment.status = "success"
  Backend: Stores vercelUrl and railwayUrl
  Backend: Records duration_seconds

STEP 7: USER GETS URLS
  Frontend: Shows green checkmark âœ…
  Frontend: Displays clickable links:
    â€¢ Frontend: https://mundo-tango.vercel.app
    â€¢ Backend: https://mundo-tango.railway.app
  Frontend: Shows "Completed in 147s"

=======================================================================
ğŸ—„ï¸ DATABASE SCHEMA
=======================================================================

TABLE: deployments
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Column                 â”‚ Type               â”‚ Description           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id                     â”‚ serial PRIMARY KEY â”‚ Auto-increment ID     â”‚
â”‚ user_id                â”‚ integer NOT NULL   â”‚ FK â†’ users.id         â”‚
â”‚ type                   â”‚ varchar(20)        â”‚ production/preview    â”‚
â”‚ status                 â”‚ varchar(20)        â”‚ pending/building/...  â”‚
â”‚ git_commit_sha         â”‚ varchar(40)        â”‚ Full SHA hash         â”‚
â”‚ git_branch             â”‚ varchar(255)       â”‚ main/develop          â”‚
â”‚ git_commit_message     â”‚ text               â”‚ Latest commit msg     â”‚
â”‚ vercel_url             â”‚ text               â”‚ Frontend URL          â”‚
â”‚ railway_url            â”‚ text               â”‚ Backend URL           â”‚
â”‚ vercel_deployment_id   â”‚ varchar(255)       â”‚ Vercel ID             â”‚
â”‚ railway_deployment_id  â”‚ varchar(255)       â”‚ Railway ID            â”‚
â”‚ build_logs             â”‚ text               â”‚ Complete build logs   â”‚
â”‚ error_message          â”‚ text               â”‚ Error if failed       â”‚
â”‚ started_at             â”‚ timestamp          â”‚ Start time            â”‚
â”‚ completed_at           â”‚ timestamp          â”‚ End time              â”‚
â”‚ duration_seconds       â”‚ integer            â”‚ Total time            â”‚
â”‚ created_at             â”‚ timestamp          â”‚ Record creation       â”‚
â”‚ updated_at             â”‚ timestamp          â”‚ Last update           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

INDEXES:
  â€¢ deployments_user_id_idx ON user_id
  â€¢ deployments_status_idx ON status
  â€¢ deployments_type_idx ON type
  â€¢ deployments_created_at_idx ON created_at DESC

=======================================================================
ğŸ”Œ API INTEGRATION POINTS
=======================================================================

GITHUB API (via @octokit/rest):
  â€¢ Get repository info
  â€¢ Get latest commit on branch
  â€¢ Trigger deployment (GitHub Actions)
  â€¢ List deployments

VERCEL API:
  â€¢ POST /v13/deployments
    Body: { name, gitSource: { type: "github", repoId, ref } }
    Returns: { id, url, readyState }
  
  â€¢ GET /v13/deployments/:id
    Returns: { readyState: "READY"|"ERROR"|"BUILDING" }

RAILWAY API:
  â€¢ POST /projects/:projectId/deployments
    Body: { environmentId, branch }
    Returns: { id, status }
  
  â€¢ GET /deployments/:id
    Returns: { status: "SUCCESS"|"FAILED"|"BUILDING" }

=======================================================================
ğŸ“ IMPLEMENTATION CHECKLIST
=======================================================================

âœ… COMPLETED (MB.MD Simultaneous Execution):
  âœ… Database schema created (shared/platform-schema.ts)
  âœ… Backend routes created (server/routes/deployments.ts)
  âœ… Frontend component created (client/src/components/platform/DeployButton.tsx)
  âœ… GitHub client helper (server/lib/github-client.ts)
  âœ… Routes registered (server/routes.ts)
  âœ… Documentation created (this file)

â³ TODO (Next Steps):
  â³ Add storage layer methods (server/storage.ts)
  â³ Implement Vercel API client (server/lib/vercel-client.ts)
  â³ Implement Railway API client (server/lib/railway-client.ts)
  â³ Add webhook handlers for deployment status updates
  â³ Add real-time updates using WebSockets
  â³ Test end-to-end deployment flow
  â³ Add DeployButton to dashboard/settings page

=======================================================================
ğŸ§ª TESTING PLAN
=======================================================================

UNIT TESTS:
  â€¢ GitHub client: getLatestCommit()
  â€¢ Deployment routes: POST /api/deployments
  â€¢ DeployButton: renders correctly

INTEGRATION TESTS:
  â€¢ Create deployment â†’ Returns valid object
  â€¢ List deployments â†’ Pagination works
  â€¢ Update deployment status â†’ Updates in DB

E2E TESTS (using run_test tool):
  1. [New Context] Create browser context
  2. [Browser] Navigate to /settings
  3. [Browser] Click "Deploy to Production" button
  4. [Verify] Deployment dialog opens
  5. [Verify] Status shows "Pending"
  6. [API] Check deployment was created in database
  7. [Verify] Progress bar visible
  8. [Browser] Wait for status to change to "Success"
  9. [Verify] Vercel URL and Railway URL are displayed
  10. [Browser] Click Vercel URL
  11. [Verify] Opens in new tab

=======================================================================
ğŸ¯ SUCCESS CRITERIA
=======================================================================

âœ… USER CAN:
  â€¢ Click one button to deploy entire app
  â€¢ See real-time progress in modal
  â€¢ Get production URLs when complete
  â€¢ Retry failed deployments
  â€¢ Cancel in-progress deployments

âœ… TECHNICAL:
  â€¢ Zero manual steps required
  â€¢ Complete in under 3 minutes
  â€¢ Handles errors gracefully
  â€¢ Logs stored in database
  â€¢ Works with any Git branch

âœ… PLATFORM INDEPENDENCE:
  â€¢ No reliance on Replit deployment UI
  â€¢ Can migrate to Vercel + Railway easily
  â€¢ User controls deployment process
  â€¢ API keys stored securely

=======================================================================
ğŸ’° COST COMPARISON
=======================================================================

BEFORE (Replit Only):
  â€¢ Replit: $20/month (Cycles plan)
  â€¢ Total: $20/month

AFTER (Vercel + Railway):
  â€¢ Vercel Hobby: $0/month (frontend)
  â€¢ Railway: $5/month (backend)
  â€¢ Total: $5/month
  
SAVINGS: $15/month ($180/year) âœ…

=======================================================================
ğŸ“š RELATED DOCUMENTATION
=======================================================================

â€¢ MB_MD_MASTER_GUIDE.txt - Methodology (Simultaneously, Recursively, Critically)
â€¢ shared/platform-schema.ts - Database schema
â€¢ server/routes/deployments.ts - Backend API
â€¢ server/lib/github-client.ts - GitHub integration
â€¢ client/src/components/platform/DeployButton.tsx - Frontend component

NEXT FEATURES:
â€¢ TIER_1_SECRETS_MANAGEMENT.txt (Feature 1.2)
â€¢ TIER_1_PREVIEW_DEPLOYMENTS.txt (Feature 1.3)

END OF DEPLOYMENT AUTOMATION DOCUMENTATION
