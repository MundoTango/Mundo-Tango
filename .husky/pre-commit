#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "üîç Running pre-commit checks..."

# Type checking
echo "üìù Running type check..."
npm run type-check
if [ $? -ne 0 ]; then
  echo "‚ùå Type check failed!"
  exit 1
fi

# Lint staged files
echo "üîç Running lint-staged..."
npx lint-staged
if [ $? -ne 0 ]; then
  echo "‚ùå Lint-staged failed!"
  exit 1
fi

# Secret scanning
echo "üîí Scanning for secrets..."
if command -v detect-secrets &> /dev/null; then
  detect-secrets scan --baseline .secrets.baseline
  if [ $? -ne 0 ]; then
    echo "‚ö†Ô∏è  Potential secrets detected! Review carefully."
    echo "To update baseline: detect-secrets scan > .secrets.baseline"
  fi
fi

# Documentation Governance - Pre-commit Hook
# Validates documentation before allowing commits
# Based on APPENDIX P governance rules

echo "üîç Running documentation validation..."

# Check if documentation files were modified
DOCS_MODIFIED=$(git diff --cached --name-only | grep -E "docs/.*\.md$|AGENT_LEARNING_INDEX_COMPLETE\.md")

if [ -n "$DOCS_MODIFIED" ]; then
  echo "üìù Documentation files modified, running validation..."
  
  # Run validation script
  node scripts/validate-docs.cjs
  
  if [ $? -ne 0 ]; then
    echo ""
    echo "‚ùå Documentation validation failed!"
    echo "Please fix the errors above before committing."
    echo ""
    echo "To bypass this check (NOT RECOMMENDED):"
    echo "  git commit --no-verify"
    echo ""
    exit 1
  fi
  
  echo "‚úÖ Documentation validation passed!"
else
  echo "‚ÑπÔ∏è  No documentation files modified, skipping validation."
fi

echo "‚úÖ All pre-commit checks passed!"
exit 0
