# Memory Feed Recommendations System - Complete Zero-Knowledge Handoff
**"Hidden Gems" Feature Documentation**

## Document Overview
This document provides comprehensive documentation for the Memory Feed Recommendations system ("Hidden Gems"), enabling users to share favorite places (restaurants, cafes, hotels, tango venues, activities) as part of their personal memory timeline.

**Document Statistics:**
- **Size:** Complete production-ready documentation
- **Last Updated:** January 9, 2025
- **Completeness:** 100% zero-knowledge reconstruction capability

**Purpose:** Enable any developer to fully understand and implement the Memory Feed Recommendations system without access to the original codebase.

---

## Table of Contents
1. [Executive Summary](#1-executive-summary)
2. [System Architecture](#2-system-architecture)
3. [PostCreator Component - 6 Animated Buttons](#3-postcreator-component)
4. [Hidden Gems Feature - Deep Dive](#4-hidden-gems-feature)
5. [Data Model & Database Schema](#5-data-model)
6. [Backend API Endpoints](#6-backend-api)
7. [City-Specific Display](#7-city-specific-display)
8. [Automatic City Creation](#8-automatic-city-creation)
9. [Multiple Recommendations Aggregation](#9-multiple-recommendations-aggregation)
10. [Integration with Tango Community Map](#10-tango-community-map-integration)
11. [User Flows & Interactions](#11-user-flows)
12. [MT Ocean Theme Styling](#12-mt-ocean-theme)
13. [Performance & Optimization](#13-performance)
14. [Testing & Validation](#14-testing)
15. [Production Deployment](#15-deployment)

---

## 1. Executive Summary

### 1.1 System Purpose

The Memory Feed Recommendations system (branded as "Hidden Gems") allows users to share favorite places as part of their personal tango journey timeline. When a user posts a recommendation, it appears in:

1. **Memory Feed** - As a social post with engagement features (likes, comments, shares)
2. **Tango Community Map** - As a geographic marker on the city-specific map

### 1.2 Key Features

âœ… **6 Animated Icon Buttons** in PostCreator for rich content creation
âœ… **5 Recommendation Categories** (Restaurant, CafÃ©, Hotel, Tango Venue, Activity)
âœ… **4 Price Ranges** ($, $$, $$$, $$$$)
âœ… **Google Maps Integration** for location picker and place details
âœ… **City-Specific Display** - Only shows on that city's map
âœ… **Automatic City Creation** - New cities created automatically
âœ… **Multiple User Aggregation** - Same place shows all user recommendations
âœ… **Dual Rating System** - Google ratings + MT community ratings
âœ… **Real-time Geocoding** via OpenStreetMap Nominatim API
âœ… **Trust Circle Privacy** - 4 visibility levels
âœ… **MT Ocean Theme** - Glassmorphic design with gradients

### 1.3 Technology Stack

- **Frontend:** React 18 + TypeScript + Tailwind CSS + shadcn/ui
- **Backend:** Express.js + TypeScript + Drizzle ORM
- **Database:** PostgreSQL (Neon serverless)
- **Maps:** Leaflet.js + React-Leaflet + OpenStreetMap
- **Location Services:** Google Maps API (place picker) + OpenStreetMap Nominatim (geocoding)
- **Photos:** Pexels API for city imagery
- **State Management:** React Query (TanStack Query v5)
- **Real-time:** Socket.io

---

## 2. System Architecture

### 2.1 High-Level Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           Memory Feed Recommendations System                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                â”‚                â”‚
   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”
   â”‚ Memory   â”‚    â”‚   Tango    â”‚   â”‚ Backend â”‚
   â”‚  Feed    â”‚â—„â”€â”€â”€â”¤ Community  â”‚â—„â”€â”€â”¤   API   â”‚
   â”‚ (Posts)  â”‚    â”‚    Map     â”‚   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
                                    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚   Database   â”‚
                                    â”‚ (PostgreSQL) â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 Data Flow

```
User Creates Recommendation
         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostCreator Component               â”‚
â”‚  - User clicks Hidden Gems button    â”‚
â”‚  - Recommendation panel opens         â”‚
â”‚  - Selects category, price, location â”‚
â”‚  - Writes review/description          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  POST /api/posts                     â”‚
â”‚  - Saves post with isRecommendation  â”‚
â”‚  - Extracts googlePlaceId            â”‚
â”‚  - Stores coordinates                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                             â”‚
               â–¼                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Memory Feed Display     â”‚    â”‚  Automation System     â”‚
â”‚  - Shows as post         â”‚    â”‚  - Check city exists   â”‚
â”‚  - Social engagement     â”‚    â”‚  - Create if new       â”‚
â”‚  - Privacy controls      â”‚    â”‚  - Geocode location    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                         â”‚
                                         â–¼
                             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                             â”‚  Tango Community Map      â”‚
                             â”‚  - City-specific display  â”‚
                             â”‚  - Aggregate by place     â”‚
                             â”‚  - Show all reviews       â”‚
                             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. PostCreator Component

### 3.1 Overview

**File:** `client/src/components/universal/PostCreator.tsx` (1,731 lines)

Universal post creation component used across Memory Feed, Events, Groups, and other contexts.

### 3.2 The 6 Animated Icon Buttons

```
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1  â”‚  2  â”‚  3  â”‚  4  â”‚  5  â”‚      6       â”‚
â”‚ ğŸ—ºï¸  â”‚  #  â”‚ ğŸ“·  â”‚ âœ¨  â”‚ ğŸŒ  â”‚  SHARE       â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
Hidden Tags Camera AI  Visib-  Share Memory
Gems             Enh  ility   (Large Button)
```

### 3.3 Button Specifications

#### Button 1: ğŸ—ºï¸ Hidden Gems (Recommendations)
- **Icon:** `MapPin` from lucide-react
- **Colors:** Amber/Orange gradient (`from-amber-500 to-orange-500`)
- **Animation:** Pin drop on hover, pulse when active
- **Tooltip:** "Hidden Gems - Share your favorite places"
- **State Management:**
  ```typescript
  const [isRecommendation, setIsRecommendation] = useState(false);
  const [recommendationType, setRecommendationType] = useState('');
  const [priceRange, setPriceRange] = useState('');
  const [location, setLocation] = useState('');
  const [locationCoordinates, setLocationCoordinates] = useState(null);
  ```

#### Button 2: # Tags
- **Icon:** `Hash`
- **Colors:** Turquoise/Cyan gradient (`from-turquoise-500 to-cyan-500`)
- **Animation:** Rotate 180Â° when active
- **15 Predefined Tags:**
  1. âœˆï¸ Travel
  2. ğŸ• Food
  3. ğŸ­ Culture
  4. ğŸ”ï¸ Adventure
  5. ğŸŒƒ Nightlife
  6. ğŸŒ¿ Nature
  7. ğŸ¨ Art
  8. ğŸµ Music
  9. âš½ Sports
  10. ğŸ“¸ Photography
  11. ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Family
  12. ğŸ‘¥ Friends
  13. ğŸ’¼ Work
  14. ğŸ¯ Milestone
  15. ğŸ‰ Celebration

#### Button 3: ğŸ“· Camera (Media Upload)
- **Icon:** `Camera`
- **Colors:** Blue/Purple gradient
- **Animation:** Shutter effect on hover
- **Limits:** 30 files max, 500MB each
- **Support:** Images (JPG, PNG, HEIC, WebP) + Videos (MP4, MOV, WebM)

#### Button 4: âœ¨ AI Enhancement
- **Icon:** `Sparkles`
- **Colors:** Pink/Purple gradient
- **API:** `POST /api/memories/enhance`
- **Features:** Content enhancement, tag suggestions, sentiment analysis

#### Button 5: ğŸŒ Visibility
- **Icon:** `Globe` / `Users` / `Lock`
- **Trust Circle Levels:**
  - **Everyone** - Public
  - **Friends** - 1st degree connections
  - **Close Friends** - Selected list
  - **Private** - Only you

#### Button 6: Share Memory
- **Large gradient button**
- **Colors:** Ocean gradient (cyan â†’ blue â†’ teal)
- **Action:** `POST /api/posts` with all collected data

---

## 4. Hidden Gems Feature - Deep Dive

### 4.1 User Interaction Flow

1. User clicks **Hidden Gems** button (ğŸ—ºï¸)
2. Recommendation panel **slides in from top**
3. User fills in **3 fields:**
   - Category (dropdown)
   - Price Range (4 toggle buttons)
   - Location (Google Maps picker)
4. User writes review/description in main text area
5. User clicks **Share Memory** button
6. Post created with `isRecommendation: true`

### 4.2 Recommendation Panel UI

#### Panel Appearance
```typescript
// Glassmorphic container
<div 
  className="mt-3 p-6 rounded-2xl space-y-5 shadow-xl animate-in slide-in-from-top-4"
  style={{
    background: 'linear-gradient(135deg, 
      hsl(173 80% 64% / 0.15) 0%, 
      hsl(177 72% 56% / 0.12) 25%, 
      hsl(180 64% 50% / 0.10) 50%, 
      hsl(194 53% 27% / 0.12) 75%, 
      hsl(173 80% 64% / 0.15) 100%)',
    backdropFilter: 'blur(20px)',
    border: '1px solid hsl(173 80% 64% / 0.3)',
    boxShadow: '0 8px 32px hsl(220 29% 33% / 0.15)'
  }}
>
```

#### Header
```tsx
<div className="flex items-center justify-center mb-4">
  <div className="relative px-6 py-3 rounded-full shadow-lg backdrop-blur-md">
    <span className="text-sm font-bold bg-gradient-to-r 
      from-turquoise-700 to-cyan-700 bg-clip-text text-transparent">
      <MapPin className="h-4 w-4" />
      Share a Recommendation
    </span>
  </div>
</div>
```

### 4.3 Field 1: Category Selection

```tsx
<select
  value={recommendationType}
  onChange={(e) => setRecommendationType(e.target.value)}
  className="w-full px-5 py-3 rounded-xl border-2 focus:outline-none 
    focus:ring-4 focus:ring-turquoise-400/30"
>
  <option value="">ğŸ“ Select a category...</option>
  <option value="restaurant">ğŸ½ï¸ Restaurant</option>
  <option value="bar">ğŸ¸ Bar</option>
  <option value="cafe">â˜• CafÃ©</option>
  <option value="hotel">ğŸ¨ Hotel</option>
  <option value="tango_venue">ğŸ’ƒ Tango Venue</option>
  <option value="activity">ğŸ¯ Activity</option>
</select>
```

**Available Categories:**
1. **ğŸ½ï¸ Restaurant** - Dining recommendations
2. **ğŸ¸ Bar** - Bar/nightlife spots
3. **â˜• CafÃ©** - Coffee shops and cafes
4. **ğŸ¨ Hotel** - Accommodation
5. **ğŸ’ƒ Tango Venue** - Milongas, practicas, tango-specific venues
6. **ğŸ¯ Activity** - Activities, experiences, attractions

### 4.4 Field 2: Price Range

```tsx
<div className="grid grid-cols-4 gap-3">
  {['$', '$$', '$$$', '$$$$'].map((price) => (
    <button
      key={price}
      onClick={() => setPriceRange(price)}
      className={`px-4 py-3 rounded-xl font-bold transition-all ${
        priceRange === price
          ? 'bg-gradient-to-br from-turquoise-500 to-cyan-600 text-white'
          : 'bg-white text-gray-700 hover:scale-105'
      }`}
    >
      {price}
    </button>
  ))}
</div>
```

**Price Range Meanings:**
- **$** - Budget-friendly (<$15/person)
- **$$** - Moderate ($15-30/person)
- **$$$** - Upscale ($30-60/person)
- **$$$$** - Luxury (>$60/person)

**Visual States:**
- **Selected:** Gradient fill (turquoise â†’ cyan) + white text
- **Unselected:** White background + gray text
- **Hover:** Scale up 1.05x + subtle glow

### 4.5 Field 3: Location Picker

**Integration:** Google Maps JavaScript API

```typescript
// Google Maps Place Autocomplete
const autocomplete = new google.maps.places.Autocomplete(inputElement, {
  types: ['establishment'],
  fields: ['place_id', 'name', 'formatted_address', 'geometry', 'rating', 'types']
});

autocomplete.addListener('place_changed', () => {
  const place = autocomplete.getPlace();
  
  setLocation(place.name);
  setLocationCoordinates({
    lat: place.geometry.location.lat(),
    lng: place.geometry.location.lng()
  });
  setGooglePlaceId(place.place_id); // For aggregation
});
```

**Extracted Data:**
- `place.name` - Business name (e.g., "La Parolaccia Trattoria")
- `place.place_id` - Unique Google Place ID (e.g., "ChIJ...")
- `place.geometry.location` - Coordinates { lat, lng }
- `place.formatted_address` - Full address
- `place.rating` - Google rating (0-5)
- `place.types` - Place types (["restaurant", "food", "point_of_interest"])

**UI Display:**
```tsx
{location && (
  <div className="flex items-center gap-2 px-4 py-3 bg-turquoise-50 
    rounded-xl border border-turquoise-200">
    <MapPin className="h-5 w-5 text-turquoise-600" />
    <span className="text-sm font-medium text-gray-800">
      {location}
    </span>
  </div>
)}
```

---

## 5. Data Model & Database Schema

### 5.1 Posts Table Extension

**File:** `shared/schema.ts`

```typescript
export const posts = pgTable("posts", {
  id: serial("id").primaryKey(),
  userId: integer("user_id").references(() => users.id).notNull(),
  content: text("content"),
  imageUrls: text("image_urls").array().default(sql`ARRAY[]::text[]`),
  
  // Recommendation fields
  isRecommendation: boolean("is_recommendation").default(false),
  recommendationType: varchar("recommendation_type", { length: 50 }), 
  // 'restaurant' | 'cafe' | 'hotel' | 'tango_venue' | 'activity' | 'bar'
  
  priceRange: varchar("price_range", { length: 10 }), 
  // '$' | '$$' | '$$$' | '$$$$'
  
  location: varchar("location", { length: 255 }),
  locationCoordinates: jsonb("location_coordinates"),
  // { lat: number, lng: number }
  
  googlePlaceId: varchar("google_place_id", { length: 255 }),
  // Unique identifier for aggregating recommendations
  
  locationDetails: jsonb("location_details"),
  // { name, address, rating, types }
  
  // Standard fields
  visibility: varchar("visibility", { length: 20 }).default("everyone"),
  tags: text("tags").array().default(sql`ARRAY[]::text[]`),
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
}, (table) => [
  index("idx_posts_user").on(table.userId),
  index("idx_posts_recommendation").on(table.isRecommendation),
  index("idx_posts_google_place").on(table.googlePlaceId),
]);
```

### 5.2 Recommendations Table

**File:** `shared/schema.ts`

```typescript
export const recommendations = pgTable("recommendations", {
  id: serial("id").primaryKey(),
  userId: integer("user_id").references(() => users.id).notNull(),
  postId: integer("post_id").references(() => posts.id),
  groupId: integer("group_id").references(() => groups.id),
  
  // Place details
  title: varchar("title", { length: 255 }).notNull(),
  description: text("description").notNull(),
  type: varchar("type", { length: 50 }).notNull(),
  
  // Location
  address: text("address"),
  city: varchar("city", { length: 100 }).notNull(),
  state: varchar("state", { length: 100 }),
  country: varchar("country", { length: 100 }).notNull(),
  lat: real("lat"),
  lng: real("lng"),
  
  // Media
  photos: text("photos").array().default(sql`ARRAY[]::text[]`),
  
  // Pricing
  priceLevel: varchar("price_level", { length: 10 }),
  
  // Tags
  tags: text("tags").array().default(sql`ARRAY[]::text[]`),
  
  // Cuisine (restaurants only)
  cuisine: varchar("cuisine", { length: 50 }),
  
  // DUAL RATING SYSTEM - KEY FOR AGGREGATION
  googlePlaceId: varchar("google_place_id", { length: 255 }),
  googleRating: real("google_rating"),
  googleReviewCount: integer("google_review_count"),
  mtRating: real("mt_rating"), // Calculated average from MT users
  mtReviewCount: integer("mt_review_count"), // Count of MT recommendations
  
  // Timestamps
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow(),
}, (table) => [
  index("idx_recommendations_user").on(table.userId),
  index("idx_recommendations_city").on(table.city),
  index("idx_recommendations_type").on(table.type),
  index("idx_recommendations_google_place").on(table.googlePlaceId), // For aggregation
  index("idx_recommendations_cuisine").on(table.cuisine),
]);
```

### 5.3 TypeScript Types

```typescript
// Insert schema for validation
export const insertPostSchema = createInsertSchema(posts).omit({
  id: true,
  createdAt: true,
  updatedAt: true,
});

export type InsertPost = z.infer<typeof insertPostSchema>;
export type SelectPost = typeof posts.$inferSelect;

// Recommendation-specific type
export interface RecommendationPost extends SelectPost {
  isRecommendation: true;
  recommendationType: string;
  priceRange: string;
  location: string;
  locationCoordinates: { lat: number; lng: number };
  googlePlaceId: string;
}
```

---

## 6. Backend API Endpoints

### 6.1 Create Recommendation Post

**Endpoint:** `POST /api/posts`

**Request Body:**
```typescript
{
  content: string; // Review/description
  isRecommendation: true;
  recommendationType: 'restaurant' | 'cafe' | 'hotel' | 'tango_venue' | 'activity' | 'bar';
  priceRange: '$' | '$$' | '$$$' | '$$$$';
  location: string; // Place name
  locationCoordinates: { lat: number; lng: number };
  googlePlaceId: string; // For aggregation
  locationDetails: {
    name: string;
    address: string;
    rating: number;
    types: string[];
  };
  visibility?: 'everyone' | 'friends' | 'close_friends' | 'private';
  tags?: string[];
  imageUrls?: string[];
}
```

**Backend Processing:**
```typescript
app.post('/api/posts', async (req, res) => {
  const { 
    content, 
    isRecommendation, 
    recommendationType,
    priceRange,
    location,
    locationCoordinates,
    googlePlaceId,
    locationDetails,
    visibility = 'everyone',
    tags = [],
    imageUrls = []
  } = req.body;
  
  // 1. Create post
  const post = await storage.createPost({
    userId: req.user.id,
    content,
    isRecommendation,
    recommendationType,
    priceRange,
    location,
    locationCoordinates,
    googlePlaceId,
    locationDetails,
    visibility,
    tags,
    imageUrls
  });
  
  // 2. If recommendation, create/update recommendation entry
  if (isRecommendation && googlePlaceId) {
    await createOrUpdateRecommendation({
      userId: req.user.id,
      postId: post.id,
      googlePlaceId,
      title: location,
      description: content,
      type: recommendationType,
      address: locationDetails.address,
      city: extractCity(locationDetails.address),
      country: extractCountry(locationDetails.address),
      lat: locationCoordinates.lat,
      lng: locationCoordinates.lng,
      priceLevel: priceRange,
      tags,
      photos: imageUrls,
      googleRating: locationDetails.rating
    });
  }
  
  // 3. Trigger automation (city creation, geocoding)
  await triggerRecommendationAutomation(post);
  
  // 4. Broadcast via Socket.io
  io.emit('memory:new', post);
  
  res.json({ success: true, post });
});
```

### 6.2 Get Recommendations by Place

**Endpoint:** `GET /api/recommendations/place/:googlePlaceId`

**Purpose:** Aggregate all user recommendations for the same place

**Response:**
```typescript
{
  place: {
    googlePlaceId: string;
    name: string;
    address: string;
    city: string;
    country: string;
    coordinates: { lat: number; lng: number };
    
    // Dual ratings
    googleRating: number;
    googleReviewCount: number;
    mtRating: number; // Average from MT users
    mtReviewCount: number; // Total MT recommendations
    
    priceLevel: string; // Most common
    type: string;
  };
  
  recommendations: Array<{
    id: number;
    userId: number;
    user: {
      id: number;
      name: string;
      profileImage: string;
    };
    description: string;
    priceRange: string;
    photos: string[];
    tags: string[];
    createdAt: string;
    postId: number; // Link back to Memory Feed post
  }>;
}
```

**Implementation:**
```typescript
app.get('/api/recommendations/place/:googlePlaceId', async (req, res) => {
  const { googlePlaceId } = req.params;
  
  // Get all recommendations for this place
  const recommendations = await storage.getRecommendationsByPlaceId(googlePlaceId);
  
  if (recommendations.length === 0) {
    return res.status(404).json({ error: 'Place not found' });
  }
  
  // Calculate aggregate data
  const mtRating = recommendations.reduce((sum, r) => sum + (r.rating || 0), 0) / recommendations.length;
  const mtReviewCount = recommendations.length;
  
  // Get most common price level
  const priceCounts = {};
  recommendations.forEach(r => {
    priceCounts[r.priceLevel] = (priceCounts[r.priceLevel] || 0) + 1;
  });
  const priceLevel = Object.keys(priceCounts).reduce((a, b) => 
    priceCounts[a] > priceCounts[b] ? a : b
  );
  
  // Build response
  const place = {
    googlePlaceId,
    name: recommendations[0].title,
    address: recommendations[0].address,
    city: recommendations[0].city,
    country: recommendations[0].country,
    coordinates: { 
      lat: recommendations[0].lat, 
      lng: recommendations[0].lng 
    },
    googleRating: recommendations[0].googleRating,
    googleReviewCount: recommendations[0].googleReviewCount,
    mtRating,
    mtReviewCount,
    priceLevel,
    type: recommendations[0].type
  };
  
  // Format recommendations with user data
  const formattedRecommendations = await Promise.all(
    recommendations.map(async (rec) => {
      const user = await storage.getUserById(rec.userId);
      return {
        id: rec.id,
        userId: rec.userId,
        user: {
          id: user.id,
          name: user.name,
          profileImage: user.profileImage
        },
        description: rec.description,
        priceRange: rec.priceLevel,
        photos: rec.photos,
        tags: rec.tags,
        createdAt: rec.createdAt,
        postId: rec.postId
      };
    })
  );
  
  res.json({
    place,
    recommendations: formattedRecommendations
  });
});
```

### 6.3 Get City Recommendations

**Endpoint:** `GET /api/recommendations?city=:city&country=:country`

**Purpose:** Get all recommendations for a specific city (for map display)

**Query Parameters:**
- `city` - City name (e.g., "Buenos Aires")
- `country` - Country name (e.g., "Argentina")
- `type` - Filter by type (optional)
- `priceRange` - Filter by price (optional)

**Response:**
```typescript
{
  recommendations: Array<{
    googlePlaceId: string;
    name: string;
    coordinates: { lat: number; lng: number };
    type: string;
    priceLevel: string;
    mtRating: number;
    mtReviewCount: number; // Number of users who recommended
    photos: string[]; // All photos from all users
  }>;
}
```

---

## 7. City-Specific Display

### 7.1 Concept

Recommendations only appear on the **specific city's map**, not globally.

**Example:**
- User in Buenos Aires recommends "La Parolaccia" â†’ Only shows on Buenos Aires map
- User in Paris recommends "CafÃ© de Flore" â†’ Only shows on Paris map

### 7.2 Implementation

**Frontend - Tango Community Map Component:**

```typescript
// File: client/src/components/map/CommunityMapWithLayers.tsx

interface CommunityMapProps {
  city: string; // e.g., "Buenos Aires"
  country: string; // e.g., "Argentina"
  center: [number, number]; // [lat, lng]
}

export function CommunityMapWithLayers({ city, country, center }: CommunityMapProps) {
  // Fetch ONLY this city's data
  const { data: mapData } = useQuery({
    queryKey: ['/api/community/map-data', city, country],
    queryFn: async () => {
      const params = new URLSearchParams({ city, country });
      const response = await fetch(`/api/community/map-data?${params}`);
      return response.json();
    }
  });
  
  return (
    <MapContainer center={center} zoom={13}>
      {/* Render only this city's recommendations */}
      {mapData?.recommendations.map((rec) => (
        <Marker 
          key={rec.googlePlaceId}
          position={[rec.coordinates.lat, rec.coordinates.lng]}
        >
          <Popup>
            <h3>{rec.name}</h3>
            <p>{rec.mtReviewCount} recommendations</p>
            <button onClick={() => viewAllReviews(rec.googlePlaceId)}>
              View All Reviews
            </button>
          </Popup>
        </Marker>
      ))}
    </MapContainer>
  );
}
```

**Backend - City Filter:**

```typescript
app.get('/api/community/map-data', async (req, res) => {
  const { city, country } = req.query;
  
  // Get events for this city
  const events = await storage.getEventsByCity(city, country);
  
  // Get housing for this city
  const housing = await storage.getHousingByCity(city, country);
  
  // Get recommendations for this city ONLY
  const recommendations = await storage.getRecommendationsByCity(city, country);
  
  res.json({
    events,
    housing,
    recommendations
  });
});
```

**Database Query:**

```typescript
async getRecommendationsByCity(city: string, country: string) {
  return await db
    .select()
    .from(recommendations)
    .where(
      and(
        eq(recommendations.city, city),
        eq(recommendations.country, country)
      )
    );
}
```

---

## 8. Automatic City Creation

### 8.1 Automation #1: City Group Assignment

**Trigger:** User creates recommendation for a city that doesn't exist

**Workflow:**
```
User posts recommendation
      â”‚
      â–¼
Extract city + country from location
      â”‚
      â–¼
Generate city group slug
(e.g., "tango-tokyo-japan")
      â”‚
      â–¼
Check if city group exists
      â”‚
      â”œâ”€ YES â†’ Join existing group
      â”‚
      â””â”€ NO â†’ Create new city:
          â”‚
          â”œâ”€ Fetch city photo from Pexels API
          â”œâ”€ Create city group record
          â”œâ”€ Set city metadata
          â””â”€ Auto-join user as member
      â”‚
      â–¼
Recommendation appears on city map
```

### 8.2 Implementation

**File:** `server/routes.ts`

```typescript
async function createOrUpdateRecommendation(data) {
  const { city, country, userId } = data;
  
  // Generate city slug
  const citySlug = `tango-${city.toLowerCase().replace(/\s+/g, '-')}-${country.toLowerCase().replace(/\s+/g, '-')}`;
  
  // Check if city group exists
  let cityGroup = await storage.getGroupBySlug(citySlug);
  
  if (!cityGroup) {
    console.log(`ğŸ†• Creating new city: ${city}, ${country}`);
    
    // Fetch authentic city photo from Pexels
    const cityPhoto = await CityPhotoService.fetchCityPhoto(city, country);
    
    // Create city group
    cityGroup = await storage.createGroup({
      name: `Tango ${city}, ${country}`,
      slug: citySlug,
      type: 'city',
      emoji: 'ğŸ™ï¸',
      imageUrl: cityPhoto?.url || '/default-city.jpg',
      description: `Connect with tango dancers in ${city}, ${country}. Share events, find partners, and discover the local tango scene.`,
      city,
      country,
      createdBy: userId,
      metadata: {
        photographer: cityPhoto?.photographer,
        coordinates: { lat: data.lat, lng: data.lng }
      }
    });
    
    console.log(`âœ… Created city group: ${cityGroup.name}`);
  }
  
  // Auto-join user to city group
  const isMember = await storage.checkUserInGroup(userId, cityGroup.id);
  if (!isMember) {
    await storage.addUserToGroup(userId, cityGroup.id, 'member');
    console.log(`âœ… Joined user ${userId} to ${cityGroup.name}`);
  }
  
  // Create recommendation entry
  return await storage.createRecommendation({
    ...data,
    groupId: cityGroup.id
  });
}
```

### 8.3 City Photo Service

**File:** `server/services/cityPhotoService.ts`

```typescript
export class CityPhotoService {
  static async fetchCityPhoto(city: string, country: string) {
    try {
      const query = encodeURIComponent(`${city} ${country} cityscape landmarks`);
      
      const response = await fetch(
        `https://api.pexels.com/v1/search?query=${query}&per_page=1&orientation=landscape`,
        {
          headers: {
            'Authorization': process.env.PEXELS_API_KEY || ''
          }
        }
      );
      
      const data = await response.json();
      
      if (data.photos && data.photos.length > 0) {
        return {
          url: data.photos[0].src.large,
          photographer: data.photos[0].photographer
        };
      }
      
      console.warn(`âš ï¸ No photo found for ${city}, ${country}`);
      return null;
      
    } catch (error) {
      console.error('Pexels API error:', error);
      return null;
    }
  }
}
```

### 8.4 Example Cities Created

When users post recommendations, these cities are auto-created:

```typescript
const exampleCities = [
  {
    name: "Tango Buenos Aires, Argentina",
    slug: "tango-buenos-aires-argentina",
    coordinates: { lat: -34.6037, lng: -58.3816 }
  },
  {
    name: "Tango Paris, France",
    slug: "tango-paris-france",
    coordinates: { lat: 48.8566, lng: 2.3522 }
  },
  {
    name: "Tango Berlin, Germany",
    slug: "tango-berlin-germany",
    coordinates: { lat: 52.5200, lng: 13.4050 }
  },
  {
    name: "Tango Tokyo, Japan",
    slug: "tango-tokyo-japan",
    coordinates: { lat: 35.6762, lng: 139.6503 }
  }
];
```

---

## 9. Multiple Recommendations Aggregation

### 9.1 Concept

When multiple users recommend the **same place** (identified by `googlePlaceId`), the system:
1. Shows all user reviews when place is clicked
2. Calculates aggregate MT community rating
3. Displays total number of recommendations
4. Shows photos from all users

### 9.2 Database Strategy

**Key Field:** `googlePlaceId` (unique identifier from Google Places API)

**Example Data:**

```sql
-- User 1 recommends "La Parolaccia"
INSERT INTO recommendations (
  google_place_id, title, user_id, description, price_level, mt_rating
) VALUES (
  'ChIJxxx...', 'La Parolaccia Trattoria', 1, 'Best Italian in BA!', '$$', NULL
);

-- User 2 recommends the SAME place
INSERT INTO recommendations (
  google_place_id, title, user_id, description, price_level, mt_rating
) VALUES (
  'ChIJxxx...', 'La Parolaccia Trattoria', 2, 'Amazing tiramisu!', '$$', NULL
);

-- User 3 recommends the SAME place
INSERT INTO recommendations (
  google_place_id, title, user_id, description, price_level, mt_rating
) VALUES (
  'ChIJxxx...', 'La Parolaccia Trattoria', 3, 'Perfect after milonga', '$$$', NULL
);
```

### 9.3 Aggregation Query

```typescript
// Get all recommendations for a place
async function getAggregatedRecommendation(googlePlaceId: string) {
  // Get all user recommendations
  const userRecommendations = await db
    .select()
    .from(recommendations)
    .where(eq(recommendations.googlePlaceId, googlePlaceId))
    .orderBy(desc(recommendations.createdAt));
  
  if (userRecommendations.length === 0) {
    return null;
  }
  
  // Calculate aggregate metrics
  const mtReviewCount = userRecommendations.length;
  
  // Calculate average MT rating (if users gave ratings)
  const ratingsGiven = userRecommendations.filter(r => r.rating !== null);
  const mtRating = ratingsGiven.length > 0
    ? ratingsGiven.reduce((sum, r) => sum + r.rating, 0) / ratingsGiven.length
    : null;
  
  // Get all photos from all users
  const allPhotos = userRecommendations
    .flatMap(r => r.photos || [])
    .filter(Boolean);
  
  // Get most common price level
  const priceLevels = userRecommendations
    .map(r => r.priceLevel)
    .filter(Boolean);
  const priceLevel = getMostCommon(priceLevels);
  
  // Get all unique tags
  const allTags = [...new Set(
    userRecommendations.flatMap(r => r.tags || [])
  )];
  
  return {
    place: {
      googlePlaceId,
      name: userRecommendations[0].title,
      address: userRecommendations[0].address,
      city: userRecommendations[0].city,
      country: userRecommendations[0].country,
      coordinates: {
        lat: userRecommendations[0].lat,
        lng: userRecommendations[0].lng
      },
      type: userRecommendations[0].type,
      
      // Aggregate data
      mtRating,
      mtReviewCount,
      googleRating: userRecommendations[0].googleRating,
      googleReviewCount: userRecommendations[0].googleReviewCount,
      priceLevel,
      allPhotos,
      allTags
    },
    
    userReviews: await Promise.all(
      userRecommendations.map(async (rec) => {
        const user = await storage.getUserById(rec.userId);
        return {
          id: rec.id,
          user: {
            id: user.id,
            name: user.name,
            profileImage: user.profileImage
          },
          description: rec.description,
          photos: rec.photos,
          priceRange: rec.priceLevel,
          tags: rec.tags,
          createdAt: rec.createdAt,
          postId: rec.postId // Link to Memory Feed post
        };
      })
    )
  };
}
```

### 9.4 Map Marker Display

**Single Marker for Place:**
```tsx
<Marker 
  position={[place.coordinates.lat, place.coordinates.lng]}
  icon={createCustomIcon(place.type, place.mtReviewCount)}
>
  <Popup className="custom-popup" maxWidth={400}>
    {/* Header */}
    <div className="popup-header">
      <h3 className="text-xl font-bold">{place.name}</h3>
      <p className="text-sm text-gray-600">{place.address}</p>
    </div>
    
    {/* Ratings */}
    <div className="flex gap-4 mt-3">
      {/* Google Rating */}
      <div className="flex items-center gap-1">
        <img src="/google-icon.svg" className="w-4 h-4" />
        <span className="font-bold">{place.googleRating}</span>
        <span className="text-xs">({place.googleReviewCount})</span>
      </div>
      
      {/* MT Community Rating */}
      <div className="flex items-center gap-1">
        <span className="text-turquoise-600">â˜…</span>
        <span className="font-bold">{place.mtRating?.toFixed(1)}</span>
        <span className="text-xs text-turquoise-600">
          {place.mtReviewCount} MT {place.mtReviewCount === 1 ? 'review' : 'reviews'}
        </span>
      </div>
    </div>
    
    {/* Price & Type */}
    <div className="flex gap-2 mt-2">
      <span className="px-2 py-1 bg-gray-100 rounded text-sm">
        {place.priceLevel}
      </span>
      <span className="px-2 py-1 bg-turquoise-100 rounded text-sm">
        {place.type}
      </span>
    </div>
    
    {/* Photos Carousel (from all users) */}
    {place.allPhotos.length > 0 && (
      <div className="mt-3 flex gap-2 overflow-x-auto">
        {place.allPhotos.slice(0, 5).map((photo, i) => (
          <img 
            key={i}
            src={photo} 
            className="w-20 h-20 rounded object-cover"
          />
        ))}
      </div>
    )}
    
    {/* View All Reviews Button */}
    <button
      onClick={() => openRecommendationModal(place.googlePlaceId)}
      className="w-full mt-3 px-4 py-2 bg-gradient-to-r from-turquoise-500 
        to-cyan-600 text-white rounded-lg font-semibold"
    >
      View All {place.mtReviewCount} Reviews
    </button>
  </Popup>
</Marker>
```

### 9.5 Recommendation Modal (All Reviews)

**When user clicks "View All Reviews":**

```tsx
function RecommendationModal({ googlePlaceId }: { googlePlaceId: string }) {
  const { data } = useQuery({
    queryKey: ['/api/recommendations/place', googlePlaceId],
    queryFn: async () => {
      const res = await fetch(`/api/recommendations/place/${googlePlaceId}`);
      return res.json();
    }
  });
  
  if (!data) return <LoadingSpinner />;
  
  return (
    <Dialog open onOpenChange={onClose}>
      <DialogContent className="max-w-3xl max-h-[80vh] overflow-y-auto">
        {/* Place Header */}
        <div className="border-b pb-4">
          <h2 className="text-2xl font-bold">{data.place.name}</h2>
          <p className="text-gray-600">{data.place.address}</p>
          
          {/* Dual Ratings */}
          <div className="flex gap-6 mt-3">
            <div>
              <div className="text-sm text-gray-500">Google Rating</div>
              <div className="flex items-center gap-2">
                <span className="text-2xl font-bold">{data.place.googleRating}</span>
                <span className="text-sm">({data.place.googleReviewCount} reviews)</span>
              </div>
            </div>
            
            <div>
              <div className="text-sm text-turquoise-600">MT Community Rating</div>
              <div className="flex items-center gap-2">
                <span className="text-2xl font-bold text-turquoise-600">
                  {data.place.mtRating?.toFixed(1)}
                </span>
                <span className="text-sm text-turquoise-600">
                  ({data.place.mtReviewCount} recommendations)
                </span>
              </div>
            </div>
          </div>
        </div>
        
        {/* User Reviews */}
        <div className="space-y-4 mt-4">
          <h3 className="font-bold text-lg">
            Community Recommendations ({data.recommendations.length})
          </h3>
          
          {data.recommendations.map((review) => (
            <div 
              key={review.id}
              className="p-4 bg-gray-50 rounded-xl border"
            >
              {/* User Info */}
              <div className="flex items-center gap-3 mb-3">
                <img 
                  src={review.user.profileImage} 
                  className="w-10 h-10 rounded-full"
                />
                <div>
                  <div className="font-semibold">{review.user.name}</div>
                  <div className="text-xs text-gray-500">
                    {formatDate(review.createdAt)}
                  </div>
                </div>
              </div>
              
              {/* Review Content */}
              <p className="text-gray-700">{review.description}</p>
              
              {/* Photos */}
              {review.photos.length > 0 && (
                <div className="flex gap-2 mt-3">
                  {review.photos.map((photo, i) => (
                    <img 
                      key={i}
                      src={photo}
                      className="w-24 h-24 rounded object-cover"
                    />
                  ))}
                </div>
              )}
              
              {/* Tags */}
              {review.tags.length > 0 && (
                <div className="flex gap-2 mt-3 flex-wrap">
                  {review.tags.map((tag) => (
                    <span 
                      key={tag}
                      className="px-2 py-1 bg-turquoise-100 text-turquoise-700 
                        rounded text-xs"
                    >
                      #{tag}
                    </span>
                  ))}
                </div>
              )}
              
              {/* Link to Original Post */}
              <Link 
                href={`/memories?post=${review.postId}`}
                className="text-sm text-turquoise-600 hover:underline mt-2 block"
              >
                View full memory post â†’
              </Link>
            </div>
          ))}
        </div>
      </DialogContent>
    </Dialog>
  );
}
```

---

## 10. Tango Community Map Integration

### 10.1 Bidirectional Linking

**Memory Feed â†’ Map:**
- Recommendation post shows "View on Map" button
- Clicking opens Tango Community Map centered on the place
- Marker is highlighted/pulsing

**Map â†’ Memory Feed:**
- Map marker popup shows "View All Reviews"
- Clicking opens modal with all user recommendations
- Each review links back to original Memory Feed post

### 10.2 Map Layers

The Tango Community Map has **3 interactive layers**:

1. **Events Layer** (purple markers)
2. **Housing Layer** (teal markers)
3. **Recommendations Layer** (red markers) â† Hidden Gems appear here

### 10.3 Recommendations Layer Filters

**Filter Options:**
```typescript
const filters = {
  type: ['restaurant', 'cafe', 'hotel', 'tango_venue', 'activity', 'bar'],
  priceRange: ['$', '$$', '$$$', '$$$$'],
  cuisine: ['Italian', 'Japanese', 'Argentine', 'French', 'Mexican', ...],
  minRating: 1-5,
  minReviewCount: number
};
```

**Filter UI:**
```tsx
<div className="filters-panel glassmorphic">
  <h3>Filter Recommendations</h3>
  
  <Select value={typeFilter} onChange={setTypeFilter}>
    <option value="all">All Categories</option>
    <option value="restaurant">ğŸ½ï¸ Restaurants</option>
    <option value="cafe">â˜• CafÃ©s</option>
    <option value="hotel">ğŸ¨ Hotels</option>
    <option value="tango_venue">ğŸ’ƒ Tango Venues</option>
    <option value="activity">ğŸ¯ Activities</option>
  </Select>
  
  <div className="price-filter">
    {['$', '$$', '$$$', '$$$$'].map((price) => (
      <button
        key={price}
        className={priceFilter.includes(price) ? 'active' : ''}
        onClick={() => togglePrice(price)}
      >
        {price}
      </button>
    ))}
  </div>
  
  <div className="rating-filter">
    <label>Minimum Rating</label>
    <input 
      type="range" 
      min="1" 
      max="5" 
      step="0.5"
      value={minRating}
      onChange={(e) => setMinRating(e.target.value)}
    />
    <span>{minRating}+ stars</span>
  </div>
</div>
```

### 10.4 Custom Map Markers

**Marker Icons by Category:**

```typescript
function getRecommendationIcon(type: string, reviewCount: number) {
  const iconConfig = {
    restaurant: { emoji: 'ğŸ½ï¸', color: '#EF4444' }, // Red
    cafe: { emoji: 'â˜•', color: '#F59E0B' }, // Amber
    hotel: { emoji: 'ğŸ¨', color: '#3B82F6' }, // Blue
    tango_venue: { emoji: 'ğŸ’ƒ', color: '#EC4899' }, // Pink
    activity: { emoji: 'ğŸ¯', color: '#8B5CF6' }, // Purple
    bar: { emoji: 'ğŸ¸', color: '#F97316' } // Orange
  };
  
  const config = iconConfig[type] || iconConfig.restaurant;
  
  return L.divIcon({
    className: 'custom-marker',
    html: `
      <div class="marker-container" style="
        background: ${config.color};
        width: 40px;
        height: 40px;
        border-radius: 50% 50% 50% 0;
        transform: rotate(-45deg);
        display: flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        border: 3px solid white;
      ">
        <span style="transform: rotate(45deg); font-size: 20px;">
          ${config.emoji}
        </span>
        ${reviewCount > 1 ? `
          <div class="review-badge" style="
            position: absolute;
            top: -8px;
            right: -8px;
            background: white;
            color: ${config.color};
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            border: 2px solid ${config.color};
          ">
            ${reviewCount}
          </div>
        ` : ''}
      </div>
    `
  });
}
```

---

## 11. User Flows & Interactions

### 11.1 Flow: Create Recommendation from Memory Feed

```
Step 1: User navigates to /memories page
        â”‚
        â–¼
Step 2: Clicks "Hidden Gems" button (ğŸ—ºï¸) in PostCreator
        â”‚
        â–¼
Step 3: Recommendation panel slides in (glassmorphic design)
        â”‚
        â–¼
Step 4: Selects category (e.g., "Restaurant")
        â”‚
        â–¼
Step 5: Selects price range (e.g., "$$")
        â”‚
        â–¼
Step 6: Uses Google Maps location picker
        - Types "La Parolaccia Buenos Aires"
        - Selects from autocomplete
        - System extracts: googlePlaceId, coordinates, address
        â”‚
        â–¼
Step 7: Writes review in main text area
        "Best Italian food in Buenos Aires! The pasta is 
         absolutely authentic and the tiramisu is to die for."
        â”‚
        â–¼
Step 8: (Optional) Uploads photos via Camera button
        â”‚
        â–¼
Step 9: (Optional) Adds tags via Tags button (#Food, #Travel)
        â”‚
        â–¼
Step 10: Sets visibility via Visibility button (e.g., "Friends")
        â”‚
        â–¼
Step 11: Clicks "Share Memory" button
        â”‚
        â–¼
Step 12: POST /api/posts with recommendation data
        â”‚
        â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                             â”‚
        â–¼                             â–¼
Step 13a: Appears in Memory Feed  Step 13b: Backend automation
        - Shows as post                   - Check city exists
        - Social engagement               - Create if new
        - Glassmorphic card               - Geocode location
                                          - Create recommendation entry
                                          â”‚
                                          â–¼
                                    Step 14: Appears on Tango Community Map
                                          - Buenos Aires map only
                                          - Red restaurant marker
                                          - Clickable popup
```

### 11.2 Flow: Discover Recommendations on Map

```
Step 1: User navigates to Tango Community Map
        - Selects "Buenos Aires" from city dropdown
        â”‚
        â–¼
Step 2: Toggles "Recommendations" layer ON
        - Purple Events: OFF
        - Teal Housing: OFF
        - Red Recommendations: ON
        â”‚
        â–¼
Step 3: Sees all recommendation markers on Buenos Aires map
        - Red restaurant markers (ğŸ½ï¸)
        - Amber cafe markers (â˜•)
        - Blue hotel markers (ğŸ¨)
        - Pink tango venue markers (ğŸ’ƒ)
        â”‚
        â–¼
Step 4: Applies filters
        - Type: Restaurants only
        - Price: $$ and $$$
        - Min Rating: 4.0+
        â”‚
        â–¼
Step 5: Clicks on marker for "La Parolaccia"
        â”‚
        â–¼
Step 6: Popup shows:
        - Place name + address
        - Google rating: 4.7 (234 reviews)
        - MT rating: 4.8 (3 recommendations)
        - Price: $$
        - Photos carousel (5 photos from 3 users)
        - "View All 3 Reviews" button
        â”‚
        â–¼
Step 7: Clicks "View All 3 Reviews"
        â”‚
        â–¼
Step 8: Modal opens showing:
        - Place details at top
        - All 3 user recommendations below
        - Each shows: user, description, photos, tags
        - Links to original Memory Feed posts
        â”‚
        â–¼
Step 9: User clicks "View full memory post â†’" on Maria's review
        â”‚
        â–¼
Step 10: Navigates to /memories?post=123
        - Opens Maria's original post
        - Can like, comment, share
        - See full context of her tango journey
```

### 11.3 Flow: Multiple Users Recommend Same Place

```
Scenario: 3 users independently recommend "La Parolaccia"

User 1 (Maria) - January 5:
  â”œâ”€ Posts: "Best Italian in BA! Perfect after milonga"
  â”œâ”€ Price: $$
  â”œâ”€ Photos: [pasta.jpg, tiramisu.jpg]
  â””â”€ Creates recommendation with googlePlaceId: "ChIJxxx..."

User 2 (Carlos) - January 8:
  â”œâ”€ Posts: "Amazing tiramisu! Great wine selection"
  â”œâ”€ Price: $$$
  â”œâ”€ Photos: [wine.jpg, dessert.jpg]
  â””â”€ Creates recommendation with SAME googlePlaceId: "ChIJxxx..."
      â”‚
      â””â”€ System detects duplicate googlePlaceId
          â”œâ”€ Creates new recommendation entry
          â”œâ”€ Updates mtReviewCount: 1 â†’ 2
          â””â”€ Recalculates mtRating

User 3 (Sofia) - January 10:
  â”œâ”€ Posts: "Cozy atmosphere, authentic Italian"
  â”œâ”€ Price: $$
  â”œâ”€ Photos: [interior.jpg, pizza.jpg]
  â””â”€ Creates recommendation with SAME googlePlaceId: "ChIJxxx..."
      â”‚
      â””â”€ System detects duplicate googlePlaceId
          â”œâ”€ Creates new recommendation entry
          â”œâ”€ Updates mtReviewCount: 2 â†’ 3
          â””â”€ Recalculates mtRating

Result on Map:
  â”œâ”€ Single marker for "La Parolaccia"
  â”œâ”€ Badge shows "3" (number of recommendations)
  â”œâ”€ Popup shows:
  â”‚   â”œâ”€ Google: 4.7 (234 reviews)
  â”‚   â”œâ”€ MT: 4.6 (3 recommendations)
  â”‚   â””â”€ Photos: 6 total (from all 3 users)
  â””â”€ "View All 3 Reviews" button opens modal with all posts
```

---

## 12. MT Ocean Theme Styling

### 12.1 Color Palette

```css
/* MT Ocean Theme Colors */
:root {
  /* Primary Ocean Gradients */
  --ocean-gradient-main: linear-gradient(135deg, 
    #06b6d4 0%,    /* cyan-500 */
    #3b82f6 50%,   /* blue-500 */
    #14b8a6 100%   /* teal-500 */
  );
  
  /* Recommendation Panel */
  --ocean-panel-bg: linear-gradient(135deg,
    hsl(173 80% 64% / 0.15) 0%,
    hsl(177 72% 56% / 0.12) 25%,
    hsl(180 64% 50% / 0.10) 50%,
    hsl(194 53% 27% / 0.12) 75%,
    hsl(173 80% 64% / 0.15) 100%
  );
  
  /* Icon Button Gradients */
  --hidden-gems-gradient: linear-gradient(135deg, #f59e0b, #ea580c);
  --tags-gradient: linear-gradient(135deg, #06b6d4, #0891b2);
  --camera-gradient: linear-gradient(135deg, #3b82f6, #8b5cf6);
  --ai-gradient: linear-gradient(135deg, #ec4899, #a855f7);
  --visibility-gradient: linear-gradient(135deg, #14b8a6, #06b6d4);
  
  /* Glassmorphic Effects */
  --glass-bg: rgba(255, 255, 255, 0.85);
  --glass-border: rgba(255, 255, 255, 0.4);
  --glass-shadow: 0 8px 32px rgba(6, 182, 212, 0.15);
  --glass-blur: blur(20px);
}
```

### 12.2 Glassmorphic Components

**Recommendation Panel:**
```css
.recommendation-panel {
  background: var(--ocean-panel-bg);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid hsl(173 80% 64% / 0.3);
  box-shadow: 0 8px 32px hsl(220 29% 33% / 0.15),
              inset 0 1px 1px hsl(0 0% 100% / 0.5);
  border-radius: 1rem;
  padding: 1.5rem;
}
```

**Memory Feed Post Card:**
```css
.memory-post-card {
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.4);
  box-shadow: 0 8px 32px rgba(6, 182, 212, 0.15);
  border-radius: 1.5rem;
  padding: 1.5rem;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.memory-post-card:hover {
  transform: translateY(-8px) scale(1.01);
  box-shadow: 0 20px 60px rgba(6, 182, 212, 0.25);
}
```

### 12.3 Animated Icon Buttons

```css
.icon-button {
  width: 48px;
  height: 48px;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.icon-button::before {
  content: '';
  position: absolute;
  inset: 0;
  background: var(--button-gradient);
  opacity: 0.1;
  transition: opacity 0.3s;
}

.icon-button:hover::before {
  opacity: 0.2;
}

.icon-button:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
}

.icon-button.active {
  background: var(--button-gradient);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Hidden Gems Button - Pin Drop Animation */
.icon-button.hidden-gems:hover .icon {
  animation: pin-drop 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes pin-drop {
  0% { transform: translateY(-20px) scale(0.8); }
  50% { transform: translateY(5px) scale(1.1); }
  100% { transform: translateY(0) scale(1); }
}

/* Tags Button - Rotate Animation */
.icon-button.tags.active .icon {
  transform: rotate(180deg);
}

/* Camera Button - Shutter Animation */
.icon-button.camera:hover .icon {
  animation: shutter 0.4s;
}

@keyframes shutter {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(0.85); }
}
```

### 12.4 Background with Floating Orbs

```tsx
// MT Ocean Animated Background
<div className="relative min-h-screen overflow-hidden">
  {/* Gradient Background */}
  <div 
    className="fixed inset-0 -z-10"
    style={{
      background: `
        linear-gradient(135deg, 
          #06b6d4 0%,
          #3b82f6 25%,
          #0891b2 50%,
          #14b8a6 75%,
          #06b6d4 100%
        )
      `
    }}
  />
  
  {/* Animated Floating Orbs */}
  <div className="fixed inset-0 -z-10 overflow-hidden pointer-events-none">
    {/* Orb 1 - Large Cyan */}
    <div
      className="absolute w-96 h-96 rounded-full opacity-30"
      style={{
        background: 'radial-gradient(circle, rgba(6,182,212,0.8) 0%, transparent 70%)',
        filter: 'blur(80px)',
        top: '10%',
        left: '10%',
        animation: 'float-1 20s ease-in-out infinite'
      }}
    />
    
    {/* Orb 2 - Medium Blue */}
    <div
      className="absolute w-80 h-80 rounded-full opacity-25"
      style={{
        background: 'radial-gradient(circle, rgba(59,130,246,0.7) 0%, transparent 70%)',
        filter: 'blur(70px)',
        top: '50%',
        right: '15%',
        animation: 'float-2 25s ease-in-out infinite'
      }}
    />
    
    {/* Orb 3 - Small Teal */}
    <div
      className="absolute w-64 h-64 rounded-full opacity-20"
      style={{
        background: 'radial-gradient(circle, rgba(20,184,166,0.6) 0%, transparent 70%)',
        filter: 'blur(60px)',
        bottom: '15%',
        left: '30%',
        animation: 'float-3 30s ease-in-out infinite'
      }}
    />
  </div>
  
  {/* Content */}
  <div className="relative z-10">
    {/* Your content here */}
  </div>
</div>

<style jsx>{`
  @keyframes float-1 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    33% { transform: translate(30px, -30px) scale(1.1); }
    66% { transform: translate(-20px, 20px) scale(0.9); }
  }
  
  @keyframes float-2 {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    50% { transform: translate(-40px, 40px) rotate(180deg); }
  }
  
  @keyframes float-3 {
    0%, 100% { transform: translate(0, 0) scale(1); }
    25% { transform: translate(40px, 30px) scale(1.15); }
    75% { transform: translate(-30px, -20px) scale(0.85); }
  }
`}</style>
```

---

## 13. Performance & Optimization

### 13.1 Key Metrics

**Target Performance:**
- Initial Page Load: < 2 seconds
- Recommendation Panel Open: < 100ms (slide animation)
- Google Maps Autocomplete: < 300ms
- Post Creation: < 1 second
- Map Data Fetch: < 500ms
- City Photo Fetch (Pexels): < 1 second

### 13.2 Optimization Strategies

#### React Query Caching
```typescript
// Memory Feed posts
const { data: posts } = useQuery({
  queryKey: ['/api/posts/feed'],
  staleTime: 0, // Always fresh for real-time feed
  cacheTime: 5 * 60 * 1000, // Cache for 5 minutes
  refetchOnWindowFocus: true
});

// City recommendations (less frequent updates)
const { data: recommendations } = useQuery({
  queryKey: ['/api/recommendations', city, country],
  staleTime: 30 * 1000, // Fresh for 30 seconds
  cacheTime: 10 * 60 * 1000, // Cache for 10 minutes
  refetchOnWindowFocus: false
});

// Aggregated place data (stable)
const { data: place } = useQuery({
  queryKey: ['/api/recommendations/place', googlePlaceId],
  staleTime: 60 * 1000, // Fresh for 1 minute
  cacheTime: 30 * 60 * 1000, // Cache for 30 minutes
});
```

#### Database Indexing
```sql
-- Critical indexes for performance
CREATE INDEX idx_posts_recommendation ON posts(is_recommendation);
CREATE INDEX idx_posts_google_place ON posts(google_place_id);
CREATE INDEX idx_recommendations_city ON recommendations(city, country);
CREATE INDEX idx_recommendations_google_place ON recommendations(google_place_id);
CREATE INDEX idx_recommendations_type ON recommendations(type);

-- Compound index for common queries
CREATE INDEX idx_recommendations_city_type ON recommendations(city, country, type);
```

#### Image Optimization
```typescript
// Compress uploaded photos
async function compressImage(file: File): Promise<Blob> {
  const canvas = document.createElement('canvas');
  const ctx = canvas.getContext('2d');
  const img = await createImageBitmap(file);
  
  // Max dimensions
  const MAX_WIDTH = 1920;
  const MAX_HEIGHT = 1920;
  
  let width = img.width;
  let height = img.height;
  
  if (width > height) {
    if (width > MAX_WIDTH) {
      height *= MAX_WIDTH / width;
      width = MAX_WIDTH;
    }
  } else {
    if (height > MAX_HEIGHT) {
      width *= MAX_HEIGHT / height;
      height = MAX_HEIGHT;
    }
  }
  
  canvas.width = width;
  canvas.height = height;
  ctx.drawImage(img, 0, 0, width, height);
  
  return new Promise((resolve) => {
    canvas.toBlob(
      (blob) => resolve(blob),
      'image/jpeg',
      0.85 // 85% quality
    );
  });
}
```

#### Lazy Loading
```typescript
// Lazy load Google Maps API
const GoogleMapsLoader = lazy(() => import('@/components/GoogleMapsAutocomplete'));

// Only load when recommendation panel is open
{isRecommendation && (
  <Suspense fallback={<div>Loading location picker...</div>}>
    <GoogleMapsLoader onPlaceSelected={handlePlaceSelected} />
  </Suspense>
)}
```

---

## 14. Testing & Validation

### 14.1 Unit Tests

```typescript
// Test: Recommendation panel opens
describe('PostCreator - Hidden Gems', () => {
  it('opens recommendation panel when Hidden Gems button clicked', () => {
    render(<PostCreator />);
    
    const hiddenGemsButton = screen.getByTestId('button-hidden-gems');
    fireEvent.click(hiddenGemsButton);
    
    expect(screen.getByText('Share a Recommendation')).toBeInTheDocument();
    expect(screen.getByText('ğŸ“ Select a category...')).toBeInTheDocument();
  });
  
  it('validates required fields before submission', async () => {
    render(<PostCreator />);
    
    fireEvent.click(screen.getByTestId('button-hidden-gems'));
    fireEvent.click(screen.getByTestId('button-share'));
    
    await waitFor(() => {
      expect(screen.getByText('Please select a category')).toBeInTheDocument();
      expect(screen.getByText('Please select a location')).toBeInTheDocument();
    });
  });
});
```

### 14.2 Integration Tests

```typescript
// Test: Full recommendation creation flow
describe('Recommendation Creation Flow', () => {
  it('creates recommendation and appears in feed and map', async () => {
    const { user } = renderWithAuth(<MemoriesMTOcean />);
    
    // Step 1: Open recommendation panel
    fireEvent.click(screen.getByTestId('button-hidden-gems'));
    
    // Step 2: Fill in category
    fireEvent.change(screen.getByTestId('select-category'), {
      target: { value: 'restaurant' }
    });
    
    // Step 3: Select price
    fireEvent.click(screen.getByText('$$'));
    
    // Step 4: Enter location (mock Google Maps)
    const locationInput = screen.getByTestId('input-location');
    fireEvent.change(locationInput, { 
      target: { value: 'La Parolaccia Buenos Aires' }
    });
    
    // Mock Google Maps place selection
    act(() => {
      mockGooglePlaceSelection({
        place_id: 'ChIJtest123',
        name: 'La Parolaccia Trattoria',
        geometry: { location: { lat: () => -34.6, lng: () => -58.4 } },
        formatted_address: 'Armenia 1366, Buenos Aires, Argentina'
      });
    });
    
    // Step 5: Write review
    fireEvent.change(screen.getByTestId('textarea-content'), {
      target: { value: 'Best Italian food in BA!' }
    });
    
    // Step 6: Submit
    fireEvent.click(screen.getByTestId('button-share'));
    
    // Verify: Post appears in feed
    await waitFor(() => {
      expect(screen.getByText('Best Italian food in BA!')).toBeInTheDocument();
      expect(screen.getByText('La Parolaccia Trattoria')).toBeInTheDocument();
    });
    
    // Verify: API called correctly
    expect(mockFetch).toHaveBeenCalledWith('/api/posts', {
      method: 'POST',
      body: expect.objectContaining({
        isRecommendation: true,
        recommendationType: 'restaurant',
        priceRange: '$$',
        googlePlaceId: 'ChIJtest123'
      })
    });
  });
});
```

### 14.3 E2E Tests (Playwright)

```typescript
// Test: Recommendation appears on map
test('recommendation appears on Tango Community Map', async ({ page }) => {
  await page.goto('/memories');
  
  // Create recommendation
  await page.click('[data-testid="button-hidden-gems"]');
  await page.selectOption('[data-testid="select-category"]', 'restaurant');
  await page.click('text=$$');
  await page.fill('[data-testid="input-location"]', 'La Parolaccia Buenos Aires');
  await page.fill('[data-testid="textarea-content"]', 'Amazing pasta!');
  await page.click('[data-testid="button-share"]');
  
  // Wait for success
  await page.waitForSelector('text=Memory shared successfully');
  
  // Navigate to map
  await page.goto('/community/map/buenos-aires');
  
  // Toggle recommendations layer
  await page.click('[data-testid="toggle-recommendations-layer"]');
  
  // Verify marker exists
  const marker = page.locator('.leaflet-marker-icon:has-text("ğŸ½ï¸")');
  await expect(marker).toBeVisible();
  
  // Click marker
  await marker.click();
  
  // Verify popup
  await expect(page.locator('.leaflet-popup')).toContainText('La Parolaccia');
  await expect(page.locator('.leaflet-popup')).toContainText('1 MT review');
});
```

---

## 15. Production Deployment

### 15.1 Environment Variables

```bash
# Required
DATABASE_URL="postgresql://..."
PEXELS_API_KEY="your_pexels_api_key"
GOOGLE_MAPS_API_KEY="your_google_maps_api_key"

# Optional
OPENAI_API_KEY="your_openai_key" # For AI enhancement
```

### 15.2 Database Migration

```bash
# Push schema to production
npm run db:push --force

# Verify tables exist
npm run db:studio
```

### 15.3 Pre-Deploy Checklist

- [ ] All environment variables set
- [ ] Database schema up to date
- [ ] Pexels API key valid
- [ ] Google Maps API key valid with correct restrictions
- [ ] All tests passing (`npm test`)
- [ ] Build succeeds (`npm run build`)
- [ ] Workflow runs without errors
- [ ] Memory Feed loads correctly
- [ ] Recommendations can be created
- [ ] Recommendations appear on map
- [ ] Multiple recommendations aggregate correctly
- [ ] City auto-creation works
- [ ] Socket.io real-time updates working

### 15.4 Monitoring

**Key Metrics to Track:**
- Recommendation creation rate
- Failed geocoding attempts
- Pexels API errors
- Google Maps API quota usage
- Average post creation time
- Map load time per city
- Cache hit rates

### 15.5 Backup Strategy

```sql
-- Daily backup of recommendations
pg_dump -t recommendations > recommendations_backup_$(date +%Y%m%d).sql

-- Backup posts with recommendations
pg_dump -t posts --where "is_recommendation = true" > recommendation_posts_backup_$(date +%Y%m%d).sql
```

---

## Appendix A: Complete API Reference

### Posts API
- `POST /api/posts` - Create post/recommendation
- `GET /api/posts/feed` - Get memory feed
- `PATCH /api/posts/:id` - Update post
- `DELETE /api/posts/:id` - Delete post
- `POST /api/posts/:id/like` - Like post
- `POST /api/posts/:id/comment` - Comment on post

### Recommendations API
- `GET /api/recommendations` - Get recommendations by city
- `GET /api/recommendations/place/:googlePlaceId` - Get aggregated place data
- `POST /api/recommendations` - Create recommendation (called internally by POST /api/posts)
- `GET /api/recommendations/user/:userId` - Get user's recommendations

### Groups API (City Auto-Creation)
- `GET /api/groups/slug/:slug` - Check if city group exists
- `POST /api/groups` - Create city group
- `POST /api/groups/:id/join` - Join city group

---

## Appendix B: TypeScript Interfaces

```typescript
// Complete type definitions
interface RecommendationData {
  isRecommendation: true;
  recommendationType: 'restaurant' | 'cafe' | 'hotel' | 'tango_venue' | 'activity' | 'bar';
  priceRange: '$' | '$$' | '$$$' | '$$$$';
  location: string;
  locationCoordinates: { lat: number; lng: number };
  googlePlaceId: string;
  locationDetails: {
    name: string;
    address: string;
    rating?: number;
    types?: string[];
  };
}

interface AggregatedPlace {
  place: {
    googlePlaceId: string;
    name: string;
    address: string;
    city: string;
    country: string;
    coordinates: { lat: number; lng: number };
    type: string;
    googleRating?: number;
    googleReviewCount?: number;
    mtRating?: number;
    mtReviewCount: number;
    priceLevel: string;
    allPhotos: string[];
    allTags: string[];
  };
  userReviews: UserReview[];
}

interface UserReview {
  id: number;
  userId: number;
  user: {
    id: number;
    name: string;
    profileImage: string;
  };
  description: string;
  priceRange: string;
  photos: string[];
  tags: string[];
  createdAt: string;
  postId: number;
}
```

---

## Document End

**Status:** Production-Ready âœ…  
**Last Updated:** January 9, 2025  
**Total Lines:** 2,800+  
**Zero-Knowledge Reconstruction:** Complete
