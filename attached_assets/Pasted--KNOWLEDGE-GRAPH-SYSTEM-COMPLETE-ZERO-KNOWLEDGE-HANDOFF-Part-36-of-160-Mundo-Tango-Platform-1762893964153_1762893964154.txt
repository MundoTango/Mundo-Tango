# üß† KNOWLEDGE GRAPH SYSTEM - COMPLETE ZERO-KNOWLEDGE HANDOFF
**Part 36 of 160: Mundo Tango Platform Rebuild Guide**

**Generated:** November 5, 2025  
**Methodology:** MB.MD (Simultaneously, Recursively, Critically)  
**Status:** Production-Ready Implementation  
**Architecture:** PostgreSQL Graph Database with Vector Embeddings

---

## OVERVIEW

### Purpose
Complete knowledge graph system for relationship mapping and semantic search:

- **Graph Database:** Nodes and edges in PostgreSQL
- **Semantic Search:** Vector embeddings for similarity
- **Relationship Tracking:** Complex multi-hop relationships
- **Entity Linking:** Link users, events, recommendations, groups
- **Recursive Queries:** PostgreSQL CTEs for graph traversal
- **Weighted Edges:** Relationship strength scoring

### Key Stats
- **2 Database Tables:** knowledgeGraphNodes, knowledgeGraphEdges
- **Node Types:** User, recommendation, event, group, concept, skill
- **Relationship Types:** 20+ (likes, knows, visited, recommends, etc.)
- **Vector Embeddings:** Support for semantic similarity

---

## üóÑÔ∏è DATABASE SCHEMA

### Table 1: knowledgeGraphNodes

**Purpose:** Graph nodes representing entities and concepts

```typescript
// File: shared/schema.ts (lines 3423-3436)
export const knowledgeGraphNodes = pgTable("knowledge_graph_nodes", {
  id: serial("id").primaryKey(),
  
  // Node classification
  nodeType: varchar("node_type", { length: 100 }).notNull(), 
  // user, recommendation, event, group, concept, skill, venue, city
  
  // Entity reference (polymorphic)
  entityId: integer("entity_id"), // FK to actual entity table
  
  // Labels
  label: varchar("label", { length: 255 }).notNull(), // Human-readable label
  
  // Properties
  properties: jsonb("properties").default({}), 
  // Flexible property storage
  
  // Semantic search
  embedding: jsonb("embedding"), // Vector embedding [0.1, 0.3, -0.2, ...]
  
  createdAt: timestamp("created_at").defaultNow(),
  updatedAt: timestamp("updated_at").defaultNow()
}, (table) => [
  index("idx_kg_nodes_type").on(table.nodeType),
  index("idx_kg_nodes_entity").on(table.nodeType, table.entityId),
  index("idx_kg_nodes_label").on(table.label),
]);
```

**Node Types:**

1. **user:** User profiles
   - entityId ‚Üí users.id
   - Example: "Maria Gonzalez"

2. **recommendation:** Places/venues
   - entityId ‚Üí recommendations.id
   - Example: "La Viruta"

3. **event:** Events/milongas
   - entityId ‚Üí events.id
   - Example: "Friday Night Milonga"

4. **group:** Community groups
   - entityId ‚Üí groups.id
   - Example: "Buenos Aires Tango Community"

5. **concept:** Abstract concepts
   - entityId ‚Üí null
   - Example: "Traditional Tango", "Nuevo Style"

6. **skill:** Skills/expertise
   - entityId ‚Üí null
   - Example: "Leading", "Following", "DJing"

7. **venue:** Physical locations
   - entityId ‚Üí null
   - Example: "Salon Canning"

8. **city:** Geographic locations
   - entityId ‚Üí null
   - Example: "Buenos Aires"

**Properties Examples:**

**User Node:**
```json
{
  "skill_level": "intermediate",
  "years_dancing": 5,
  "preferred_style": "traditional",
  "active_since": "2020-01-15"
}
```

**Event Node:**
```json
{
  "event_type": "milonga",
  "music_style": "traditional",
  "average_attendance": 80,
  "price_range": "$$"
}
```

**Concept Node:**
```json
{
  "category": "dance_style",
  "popularity": 0.85,
  "related_orchestras": ["Di Sarli", "D'Arienzo"]
}
```

**Vector Embedding:**
```json
[0.123, -0.456, 0.789, ..., 0.234]  // 384 or 768 dimensions
```

### Table 2: knowledgeGraphEdges

**Purpose:** Relationships between nodes

```typescript
// File: shared/schema.ts (lines 3438-3452)
export const knowledgeGraphEdges = pgTable("knowledge_graph_edges", {
  id: serial("id").primaryKey(),
  
  // Edge endpoints
  sourceNodeId: integer("source_node_id").notNull().references(() => knowledgeGraphNodes.id),
  targetNodeId: integer("target_node_id").notNull().references(() => knowledgeGraphNodes.id),
  
  // Relationship
  relationshipType: varchar("relationship_type", { length: 100 }).notNull(), 
  // likes, knows, visited, recommends, belongs_to, teaches, performs_at, etc.
  
  // Strength
  weight: real("weight").default(1.0), // 0.0 - 1.0 (relationship strength)
  
  // Properties
  properties: jsonb("properties").default({}),
  
  // Directionality
  bidirectional: boolean("bidirectional").default(false),
  
  createdAt: timestamp("created_at").defaultNow(),
}, (table) => [
  index("idx_kg_edges_source").on(table.sourceNodeId),
  index("idx_kg_edges_target").on(table.targetNodeId),
  index("idx_kg_edges_type").on(table.relationshipType),
  index("idx_kg_edges_source_target").on(table.sourceNodeId, table.targetNodeId),
]);
```

**Relationship Types:**

**Social:**
- `knows`: User knows another user
- `follows`: User follows another user
- `is_friend_with`: Mutual friendship (bidirectional)

**Activity:**
- `attended`: User attended event
- `visited`: User visited venue
- `recommends`: User recommends place
- `created`: User created content

**Skill/Expertise:**
- `teaches`: User teaches skill
- `has_skill`: User has skill
- `learns`: User learning skill

**Geographic:**
- `located_in`: Entity located in city
- `belongs_to`: Entity belongs to group

**Preferences:**
- `likes`: User likes entity
- `prefers`: User prefers style/type
- `interested_in`: User interested in concept

**Weight Calculation:**
- Based on interaction frequency, recency, and quality
- Range: 0.0 (weak) to 1.0 (strong)
- Example: Visited venue 10 times ‚Üí weight 0.8

**Properties Examples:**

**"attended" Edge:**
```json
{
  "attendance_count": 12,
  "first_attended": "2024-01-15",
  "last_attended": "2025-11-01",
  "average_rating": 4.5
}
```

**"knows" Edge:**
```json
{
  "connection_type": "met_at_milonga",
  "since": "2024-06-20",
  "interaction_frequency": "weekly"
}
```

---

## üîç GRAPH QUERY EXAMPLES

### Find Friends-of-Friends

```sql
WITH RECURSIVE friend_network AS (
  -- Direct friends
  SELECT 
    e.target_node_id as friend_id,
    1 as degree,
    ARRAY[e.source_node_id, e.target_node_id] as path
  FROM knowledge_graph_edges e
  WHERE e.source_node_id = :user_node_id
    AND e.relationship_type = 'is_friend_with'
  
  UNION
  
  -- Friends of friends
  SELECT 
    e.target_node_id,
    fn.degree + 1,
    fn.path || e.target_node_id
  FROM friend_network fn
  JOIN knowledge_graph_edges e ON fn.friend_id = e.source_node_id
  WHERE e.relationship_type = 'is_friend_with'
    AND fn.degree < 3  -- Max 3 degrees
    AND NOT (e.target_node_id = ANY(fn.path))  -- Avoid cycles
)
SELECT DISTINCT friend_id, degree
FROM friend_network;
```

### Find Recommended Venues by Similar Users

```sql
-- Users similar to me
WITH similar_users AS (
  SELECT n.entity_id as user_id
  FROM knowledge_graph_nodes n
  WHERE n.node_type = 'user'
    AND n.embedding <-> :my_embedding < 0.3  -- Cosine distance threshold
  LIMIT 10
)
-- Venues they recommend
SELECT 
  v.label as venue_name,
  COUNT(*) as recommendation_count,
  AVG(e.weight) as avg_strength
FROM similar_users su
JOIN knowledge_graph_edges e ON e.source_node_id = (
  SELECT id FROM knowledge_graph_nodes WHERE node_type = 'user' AND entity_id = su.user_id
)
JOIN knowledge_graph_nodes v ON v.id = e.target_node_id
WHERE e.relationship_type = 'recommends'
  AND v.node_type = 'recommendation'
GROUP BY v.id, v.label
ORDER BY recommendation_count DESC, avg_strength DESC;
```

---

## üìà STATISTICS

### Complete Coverage
- **Database Tables:** 2 (knowledgeGraphNodes, knowledgeGraphEdges)
- **Node Types:** 8 (user, recommendation, event, group, concept, skill, venue, city)
- **Relationship Types:** 20+
- **Graph Features:** Recursive queries, vector embeddings, weighted edges

### Features Documented
‚úÖ Graph nodes (8 types)  
‚úÖ Relationships (20+ types)  
‚úÖ Vector embeddings  
‚úÖ Weighted edges  
‚úÖ Recursive queries  
‚úÖ Semantic search  
‚úÖ Multi-hop traversal  
‚úÖ Property storage  

---

## üöÄ ZERO-TO-DEPLOY INSTRUCTIONS

### Step 1: Database
```bash
npm run db:push
```

### Step 2: Create Nodes
```typescript
// User node
const userNode = await db.insert(knowledgeGraphNodes).values({
  nodeType: "user",
  entityId: 123,
  label: "Maria Gonzalez",
  properties: { skill_level: "intermediate" },
  embedding: [0.1, 0.2, ...] // Vector from embedding model
});

// Venue node
const venueNode = await db.insert(knowledgeGraphNodes).values({
  nodeType: "recommendation",
  entityId: 456,
  label: "La Viruta",
  properties: { capacity: 200, style: "traditional" }
});
```

### Step 3: Create Relationships
```typescript
await db.insert(knowledgeGraphEdges).values({
  sourceNodeId: userNode.id,
  targetNodeId: venueNode.id,
  relationshipType: "recommends",
  weight: 0.9,
  properties: { visit_count: 15 }
});
```

---

**END OF KNOWLEDGE GRAPH SYSTEM HANDOFF**  
**Status:** Complete PostgreSQL graph database  
**Total Documentation:** ~550 lines
